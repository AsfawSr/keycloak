<!DOCTYPE html>
<html>
<head>
    <title>Keycloak Auth Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { display: flex; gap: 40px; }
        .form-container { flex: 1; }
        .token-display { flex: 1; background: #f5f5f5; padding: 15px; border-radius: 5px; }
        form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Keycloak Authentication Demo</h1>

    <div class="container">
        <!-- Registration Form -->
        <div class="form-container">
            <h2>Register</h2>
            <form id="registerForm">
                <input type="text" name="username" placeholder="Username" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="firstName" placeholder="First Name" required>
                <input type="text" name="lastName" placeholder="Last Name" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit">Register</button>
            </form>
            <div id="registerMessage"></div>
        </div>

        <!-- Login Form -->
        <div class="form-container">
            <h2>Login</h2>
            <form id="loginForm">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <div id="loginMessage"></div>
        </div>
    </div>

    <!-- Current User Info -->
    <div class="token-display">
        <h2>Current Session</h2>
        <div>
            <button onclick="getCurrentUser()">Get My Info</button>
            <button onclick="logout()" style="background: #dc3545;">Logout</button>
            <button onclick="refreshToken()" style="background: #28a745;">Refresh Token</button>
        </div>
        <pre id="userInfo"></pre>
        <pre id="tokenInfo"></pre>
    </div>

    <script>
        let accessToken = localStorage.getItem('accessToken');
        let refreshToken = localStorage.getItem('refreshToken');

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.text();
                document.getElementById('registerMessage').innerHTML =
                    response.ok ? `<p class="success">${result}</p>` : `<p class="error">${result}</p>`;
            } catch (error) {
                document.getElementById('registerMessage').innerHTML =
                    `<p class="error">Error: ${error.message}</p>`;
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    accessToken = result.accessToken;
                    refreshToken = result.refreshToken;

                    // Store tokens
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);

                    document.getElementById('loginMessage').innerHTML =
                        `<p class="success">Login successful!</p>`;
                    document.getElementById('tokenInfo').textContent =
                        `Access Token: ${accessToken.substring(0, 50)}...`;
                } else {
                    const error = await response.text();
                    document.getElementById('loginMessage').innerHTML =
                        `<p class="error">${error}</p>`;
                }
            } catch (error) {
                document.getElementById('loginMessage').innerHTML =
                    `<p class="error">Error: ${error.message}</p>`;
            }
        });

        // Get Current User
        async function getCurrentUser() {
            if (!accessToken) {
                alert('Please login first');
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userInfo').textContent =
                        JSON.stringify(user, null, 2);
                } else {
                    alert('Failed to get user info');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Logout
        async function logout() {
            if (!refreshToken) {
                alert('No active session');
                return;
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    // Clear tokens
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    accessToken = null;
                    refreshToken = null;

                    document.getElementById('userInfo').textContent = '';
                    document.getElementById('tokenInfo').textContent = '';
                    alert('Logged out successfully');
                } else {
                    alert('Logout failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Refresh Token
        async function refreshToken() {
            if (!refreshToken) {
                alert('No refresh token available');
                return;
            }

            try {
                const response = await fetch(`/api/auth/refresh?refresh_token=${encodeURIComponent(refreshToken)}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    accessToken = result.accessToken;
                    refreshToken = result.refreshToken;

                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);

                    document.getElementById('tokenInfo').textContent =
                        `Token refreshed!\nNew Access Token: ${accessToken.substring(0, 50)}...`;
                } else {
                    alert('Token refresh failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Auto-refresh token when about to expire
        function setupAutoRefresh() {
            // Check token expiration every minute
            setInterval(async () => {
                if (accessToken) {
                    // Simple check - in real app, decode JWT and check exp
                    const response = await fetch('/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });

                    if (response.status === 401 && refreshToken) {
                        console.log('Token expired, attempting refresh...');
                        await refreshToken();
                    }
                }
            }, 60000); // Check every minute
        }

        // Initialize
        if (accessToken) {
            document.getElementById('tokenInfo').textContent =
                `Access Token: ${accessToken.substring(0, 50)}...`;
        }

        setupAutoRefresh();
    </script>
</body>
</html>